<script>
    let prefix = ["https://pay.kirvano.com"];

    function getParams() {
        let t = "",
            e = window.top.location.href,
            r = new URL(e);

        if (r) {
            let a = r.searchParams.get("utm_source"),
                n = r.searchParams.get("utm_medium"),
                o = r.searchParams.get("utm_campaign"),
                p = r.searchParams.get("fbclid"),
                c = r.searchParams.get("utm_content"),
                utm_term = getCookie("Leadsf"); // Obtém o valor do cookie "Leadsf"

            // Verifica se o "utm_source" existe na URL
            if (!a) {
                // Se não existir, usa o referrer da página
                let referrer = document.referrer;

                if (referrer) {
                    try {
                        let hostname = new URL(referrer).hostname;
                        a = getPlatformName(hostname); // Filtra o nome da plataforma
                    } catch (error) {
                        a = "direto"; // Se o referrer não for uma URL válida, define como "direto"
                    }
                } else {
                    a = "direto"; // Se o referrer estiver vazio, define "utm_source" como "direto"
                }
            }

            // Constrói a string de parâmetros incluindo o utm_source e o xcod atualizado
            t = `utm_source=${a}&utm_term=${utm_term}`;
            if (n || o || p || c) {
                t += `&utm_medium=${n}&utm_campaign=${o}&utm_content=${c}&fbclid=${p}`;
            }
        }
        return t;
    }

    function getCookie(name) {
        let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (match) {
            return match[2];
        }
        return null;
    }

    function getPlatformName(hostname) {
        // Remover "www.", subdomínios de um único caractere e ".com", ".net", etc.
        let domainParts = hostname.replace(/^www\./, '').split('.');
        
        // Se houver mais de 2 partes no hostname, provavelmente é um subdomínio
        if (domainParts.length > 2) {
            // Exemplo: l.instagram.com -> filtrar para pegar apenas instagram
            domainParts = domainParts.slice(-2); // Pega os dois últimos elementos (domínio principal e TLD)
        }

        // Capitalizar o nome da plataforma
        let name = domainParts[0];
        return name.charAt(0).toUpperCase() + name.slice(1);
    }

    function updateLinks() {
        let params = getParams();
        if (params) {
            document.querySelectorAll("a").forEach(function(e) {
                for (let r = 0; r < prefix.length; r++) {
                    if (e.href.indexOf(prefix[r]) !== -1) {
                        if (e.href.indexOf("?") === -1) {
                            e.href += "?" + params;
                        } else {
                            e.href += "&" + params;
                        }
                    }
                }
            });
        }
    }

    window.addEventListener('load', function() {
        updateLinks();
    });
</script>
